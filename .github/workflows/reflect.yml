# GitHub Actions ÏõåÌÅ¨ÌîåÎ°úÏö∞ - Ï°∞Í±¥Î∂Ä Î¶¨ÌîåÎ†âÏÖò Ïã§Ìñâ
# Ïô∏Î∂Ä Î†àÌçºÎü∞Ïä§: https://docs.github.com/actions/reference/workflow-syntax-for-github-actions

name: "Hybrid AI Development Workflow - Reflection"

on:
  push:
    # ÌäπÏ†ï ÌååÏùº/ÎîîÎ†âÌÜ†Î¶¨ Î≥ÄÍ≤Ω ÏãúÏóêÎßå Ïã§Ìñâ
    paths:
      - 'docs/**'           # PRD Î¨∏ÏÑú Î≥ÄÍ≤Ω
      - 'tasks.json'        # ÌÉúÏä§ÌÅ¨ Ï†ïÏùò Î≥ÄÍ≤Ω
      - '.cursor/rules/**'  # Cursor Í∑úÏπô Î≥ÄÍ≤Ω
      - 'src/**'            # ÏÜåÏä§ ÏΩîÎìú Î≥ÄÍ≤Ω
      - 'tools/**'          # ÎèÑÍµ¨ Î≥ÄÍ≤Ω
    # Ï†úÏô∏Ìï† Í≤ΩÎ°ú
    paths-ignore:
      - 'README.md'
      - '*.log'
      - '.git/**'
      - 'node_modules/**'
      - '__pycache__/**'
      - '*.pyc'
  
  pull_request:
    # PRÏóêÏÑúÎèÑ ÎèôÏùºÌïú Í≤ΩÎ°ú ÌïÑÌÑ∞ Ï†ÅÏö©
    paths:
      - 'docs/**'
      - 'tasks.json'
      - '.cursor/rules/**'
      - 'src/**'
      - 'tools/**'
  
  # ÏàòÎèô Ïã§Ìñâ (workflow_dispatch)
  workflow_dispatch:
    inputs:
      force_reflection:
        description: 'Í∞ïÏ†ú Î¶¨ÌîåÎ†âÏÖò Ïã§Ìñâ'
        required: false
        default: 'false'
        type: boolean
      skip_visualization:
        description: 'ÏãúÍ∞ÅÌôî Í±¥ÎÑàÎõ∞Í∏∞'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # Ï°∞Í±¥Î∂Ä Ïã§Ìñâ ÌôïÏù∏
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      should-reflect: ${{ steps.changes.outputs.should-reflect }}
      has-docs: ${{ steps.changes.outputs.has-docs }}
      has-code: ${{ steps.changes.outputs.has-code }}
      has-tools: ${{ steps.changes.outputs.has-tools }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Ïù¥Ï†Ñ Ïª§Î∞ãÍ≥º ÎπÑÍµêÌïòÍ∏∞ ÏúÑÌï¥
        
      - name: Detect changes
        id: changes
        run: |
          # Î≥ÄÍ≤ΩÎêú ÌååÏùº Î™©Î°ù ÌôïÏù∏
          if [ "${{ github.event_name }}" = "push" ]; then
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Î¶¨ÌîåÎ†âÏÖòÏù¥ ÌïÑÏöîÌïú Î≥ÄÍ≤ΩÏÇ¨Ìï≠ ÌôïÏù∏
          SHOULD_REFLECT="false"
          HAS_DOCS="false"
          HAS_CODE="false"
          HAS_TOOLS="false"
          
          if echo "$CHANGED_FILES" | grep -E '^(docs/|tasks\.json|\.cursor/rules/)'; then
            SHOULD_REFLECT="true"
            HAS_DOCS="true"
            echo "üìã Documentation or task changes detected"
          fi
          
          if echo "$CHANGED_FILES" | grep -E '^src/'; then
            HAS_CODE="true"
            echo "üíª Source code changes detected"
          fi
          
          if echo "$CHANGED_FILES" | grep -E '^tools/'; then
            HAS_TOOLS="true"
            echo "üîß Tool changes detected"
          fi
          
          # Í∞ïÏ†ú Ïã§Ìñâ ÏòµÏÖò ÌôïÏù∏
          if [ "${{ github.event.inputs.force_reflection }}" = "true" ]; then
            SHOULD_REFLECT="true"
            echo "üöÄ Force reflection enabled"
          fi
          
          echo "should-reflect=$SHOULD_REFLECT" >> $GITHUB_OUTPUT
          echo "has-docs=$HAS_DOCS" >> $GITHUB_OUTPUT
          echo "has-code=$HAS_CODE" >> $GITHUB_OUTPUT
          echo "has-tools=$HAS_TOOLS" >> $GITHUB_OUTPUT

  # Î¶¨ÌîåÎ†âÏÖò Ïã§Ìñâ (Ï°∞Í±¥Î∂Ä)
  reflect:
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.should-reflect == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install watchdog pyyaml
          # Graphviz ÏÑ§Ïπò (ÏãúÍ∞ÅÌôîÏö©)
          sudo apt-get update
          sudo apt-get install -y graphviz
          pip install graphviz
      
      - name: Create reports directory
        run: mkdir -p reports
      
      - name: Run reflection
        run: |
          echo "üîÑ Running task reflection..."
          python tools/tasks_reflect.py \
            --in tasks.json \
            --out tasks.reflected.json \
            --report reports/tasks_reflect_report.md
      
      - name: Generate visualizations
        if: github.event.inputs.skip_visualization != 'true'
        run: |
          echo "üé® Generating visualizations..."
          python tools/dag_visualizer.py \
            --input tasks.reflected.json \
            --format all
      
      - name: Upload reflection artifacts
        uses: actions/upload-artifact@v4
        with:
          name: reflection-results-${{ github.run_number }}
          path: |
            tasks.reflected.json
            reports/
            tasks_gantt.md
            tasks_flow.md
            visualization_summary.md
            *.svg
            *.png
          retention-days: 30

  # ÌÖåÏä§Ìä∏ Ïã§Ìñâ (ÏΩîÎìú Î≥ÄÍ≤Ω Ïãú)
  test:
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.has-code == 'true' || needs.check-changes.outputs.has-tools == 'true'
    
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install watchdog pyyaml pytest
      
      - name: Run tests
        run: |
          echo "üß™ Running tests..."
          # ÎèÑÍµ¨ ÌÖåÏä§Ìä∏ Ïã§Ìñâ
          if [ -f "tools/test_watchdog.py" ]; then
            python tools/test_watchdog.py
          fi
          if [ -f "tools/test_priority.py" ]; then
            python tools/test_priority.py
          fi
          if [ -f "tools/test_parallel.py" ]; then
            python tools/test_parallel.py
          fi
          if [ -f "tools/test_auto_reflect.py" ]; then
            python tools/test_auto_reflect.py
          fi

  # Î¶∞Ìä∏ Î∞è ÏΩîÎìú ÌíàÏßà Í≤ÄÏÇ¨
  lint:
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.has-code == 'true' || needs.check-changes.outputs.has-tools == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy
      
      - name: Run Black (code formatting)
        run: black --check --diff tools/ || true
      
      - name: Run isort (import sorting)
        run: isort --check-only --diff tools/ || true
      
      - name: Run flake8 (linting)
        run: flake8 tools/ --max-line-length=100 --extend-ignore=E203,W503 || true
      
      - name: Run mypy (type checking)
        run: mypy tools/ --ignore-missing-imports || true

  # ÏÑ±Îä• Î≤§ÏπòÎßàÌÅ¨ (ÎèÑÍµ¨ Î≥ÄÍ≤Ω Ïãú)
  benchmark:
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.has-tools == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install watchdog pyyaml psutil
      
      - name: Run performance benchmarks
        run: |
          echo "‚ö° Running performance benchmarks..."
          
          # Î¶¨ÌîåÎ†âÏÖò ÏÑ±Îä• Ï∏°Ï†ï
          time python tools/tasks_reflect.py \
            --in tasks.json \
            --out tasks.reflected.json \
            --report reports/benchmark_reflection.md
          
          # ÏãúÍ∞ÅÌôî ÏÑ±Îä• Ï∏°Ï†ï
          time python tools/dag_visualizer.py \
            --input tasks.reflected.json \
            --format mermaid
          
          # Î©îÎ™®Î¶¨ ÏÇ¨Ïö©Îüâ Ï∏°Ï†ï
          python -c "
          import psutil
          import os
          process = psutil.Process(os.getpid())
          print(f'Memory usage: {process.memory_info().rss / 1024 / 1024:.2f} MB')
          "

  # Conventional Commits Í≤ÄÏ¶ù Î∞è Î¶¥Î¶¨Ï¶à ÏÉùÏÑ±
  conventional-commits:
    runs-on: ubuntu-latest
    needs: [check-changes, reflect, test, lint]
    if: always() && needs.check-changes.outputs.should-reflect == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ï†ÑÏ≤¥ ÌûàÏä§ÌÜ†Î¶¨ ÌïÑÏöî
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml
      
      - name: Validate commit messages
        run: |
          echo "üîç Conventional Commits Í≤ÄÏ¶ù Ï§ë..."
          python tools/conventional_commits.py --validate
      
      - name: Generate CHANGELOG
        run: |
          echo "üìù CHANGELOG ÏÉùÏÑ± Ï§ë..."
          python tools/conventional_commits.py --generate-changelog --output CHANGELOG.md
      
      - name: Check for release trigger
        id: release-check
        run: |
          # ÏµúÍ∑º Ïª§Î∞ãÎì§ÏóêÏÑú feat ÎòêÎäî fixÍ∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
          recent_commits=$(git log --oneline -10)
          
          if echo "$recent_commits" | grep -E "^[a-f0-9]+ feat\(|^[a-f0-9]+ fix\("; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "üöÄ Î¶¥Î¶¨Ï¶à Ìä∏Î¶¨Í±∞ Í∞êÏßÄÎê®"
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Î¶¥Î¶¨Ï¶à Ìä∏Î¶¨Í±∞ ÏóÜÏùå"
          fi
      
      - name: Create release
        if: steps.release-check.outputs.should_release == 'true'
        run: |
          echo "üöÄ Î¶¥Î¶¨Ï¶à ÏÉùÏÑ± Ï§ë..."
          python tools/conventional_commits.py --create-release --draft
      
      - name: Upload CHANGELOG
        uses: actions/upload-artifact@v4
        with:
          name: changelog-${{ github.run_number }}
          path: CHANGELOG.md
          retention-days: 30

  # ÏïåÎ¶º Î∞è Î≥¥Í≥†ÏÑú ÏÉùÏÑ±
  notify:
    runs-on: ubuntu-latest
    needs: [check-changes, reflect, test, lint, conventional-commits]
    if: always()
    
    steps:
      - name: Generate workflow summary
        run: |
          echo "# Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìä Execution Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Reflection**: ${{ needs.reflect.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests**: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Linting**: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Conventional Commits**: ${{ needs.conventional-commits.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üîç Change Detection" >> $GITHUB_STEP_SUMMARY
          echo "- **Documentation**: ${{ needs.check-changes.outputs.has-docs }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Code**: ${{ needs.check-changes.outputs.has-code }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tools**: ${{ needs.check-changes.outputs.has-tools }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìà Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Check the 'Artifacts' section for generated files." >> $GITHUB_STEP_SUMMARY
      
      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('üîÑ Reflection Results')
            );
            
            const reflectionResult = '${{ needs.reflect.result }}';
            const testResult = '${{ needs.test.result }}';
            const lintResult = '${{ needs.lint.result }}';
            
            const statusEmoji = {
              'success': '‚úÖ',
              'failure': '‚ùå',
              'cancelled': '‚ö†Ô∏è',
              'skipped': '‚è≠Ô∏è'
            };
            
            const commentBody = `## üîÑ Reflection Results
            
            | Job | Status | Result |
            |-----|--------|--------|
            | Reflection | ${statusEmoji[reflectionResult] || '‚ùì'} | ${{ needs.reflect.result }} |
            | Tests | ${statusEmoji[testResult] || '‚ùì'} | ${{ needs.test.result }} |
            | Linting | ${statusEmoji[lintResult] || '‚ùì'} | ${{ needs.lint.result }} |
            
            **Change Detection:**
            - Documentation: ${{ needs.check-changes.outputs.has-docs }}
            - Code: ${{ needs.check-changes.outputs.has-code }}
            - Tools: ${{ needs.check-changes.outputs.has-tools }}
            
            Check the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed logs.`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }
