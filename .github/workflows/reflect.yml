# GitHub Actions ì›Œí¬í”Œë¡œìš° - ë¦¬í”Œë ‰ì…˜ ì‹¤í–‰
name: "Hybrid AI Development Workflow - Reflection"

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      force_reflection:
        description: 'ê°•ì œ ë¦¬í”Œë ‰ì…˜ ì‹¤í–‰'
        required: false
        default: 'true'
        type: boolean

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ë¦¬í”Œë ‰ì…˜ ì‹¤í–‰
  reflect:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install watchdog pyyaml schedule requests flask
          # Graphviz ì„¤ì¹˜ (ì‹œê°í™”ìš©)
          sudo apt-get update
          sudo apt-get install -y graphviz
          pip install graphviz
      
      - name: Create reports directory
        run: mkdir -p reports
      
      - name: Run reflection
        run: |
          echo "ðŸ”„ Running task reflection..."
          # reflection íŒ¨í‚¤ì§€ ê²½ë¡œ ì¶”ê°€
          export PYTHONPATH="${PYTHONPATH}:$(pwd)"
          python tools/tasks_reflect.py \
            --in tasks.json \
            --out tasks.reflected.json \
            --report reports/tasks_reflect_report.md
      
      - name: Generate visualizations
        run: |
          echo "ðŸŽ¨ Generating visualizations..."
          # reflection íŒ¨í‚¤ì§€ ê²½ë¡œ ì¶”ê°€
          export PYTHONPATH="${PYTHONPATH}:$(pwd)"
          python tools/dag_visualizer.py \
            --input tasks.reflected.json \
            --format all
      
      - name: Upload reflection artifacts
        uses: actions/upload-artifact@v4
        with:
          name: reflection-results-${{ github.run_number }}
          path: |
            tasks.reflected.json
            reports/
            tasks_gantt.md
            tasks_flow.md
            visualization_summary.md
            *.svg
            *.png
          retention-days: 30

  # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install watchdog pyyaml pytest schedule requests flask
      
      - name: Run tests
        run: |
          echo "ðŸ§ª Running tests..."
          # reflection íŒ¨í‚¤ì§€ ê²½ë¡œ ì¶”ê°€
          export PYTHONPATH="${PYTHONPATH}:$(pwd)"
          
          # ë„êµ¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          if [ -f "tools/test_watchdog.py" ]; then
            python tools/test_watchdog.py
          fi
          if [ -f "tools/test_priority.py" ]; then
            python tools/test_priority.py
          fi
          if [ -f "tools/test_parallel.py" ]; then
            python tools/test_parallel.py
          fi
          if [ -f "tools/test_auto_reflect.py" ]; then
            python tools/test_auto_reflect.py
          fi

  # ë¦°íŠ¸ ë° ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  lint:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy schedule requests flask
      
      - name: Run Black (code formatting)
        run: black --check --diff tools/ || true
      
      - name: Run isort (import sorting)
        run: isort --check-only --diff tools/ || true
      
      - name: Run flake8 (linting)
        run: flake8 tools/ --max-line-length=100 --extend-ignore=E203,W503 || true
      
      - name: Run mypy (type checking)
        run: mypy tools/ --ignore-missing-imports || true

  # ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬
  benchmark:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install watchdog pyyaml psutil schedule requests flask
      
      - name: Run performance benchmarks
        run: |
          echo "âš¡ Running performance benchmarks..."
          
          # reflection íŒ¨í‚¤ì§€ ê²½ë¡œ ì¶”ê°€
          export PYTHONPATH="${PYTHONPATH}:$(pwd)"
          
          # ë¦¬í”Œë ‰ì…˜ ì„±ëŠ¥ ì¸¡ì •
          time python tools/tasks_reflect.py \
            --in tasks.json \
            --out tasks.reflected.json \
            --report reports/benchmark_reflection.md
          
          # ì‹œê°í™” ì„±ëŠ¥ ì¸¡ì •
          time python tools/dag_visualizer.py \
            --input tasks.reflected.json \
            --format mermaid
          
          # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¸¡ì •
          python -c "
          import psutil
          import os
          process = psutil.Process(os.getpid())
          print(f'Memory usage: {process.memory_info().rss / 1024 / 1024:.2f} MB')
          "

  # ì•Œë¦¼ ë° ë³´ê³ ì„œ ìƒì„±
  notify:
    runs-on: ubuntu-latest
    needs: [reflect, test, lint, benchmark]
    if: always()
    
    steps:
      - name: Generate workflow summary
        run: |
          echo "# Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Execution Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Reflection**: ${{ needs.reflect.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests**: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Linting**: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Benchmark**: ${{ needs.benchmark.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ˆ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Check the 'Artifacts' section for generated files." >> $GITHUB_STEP_SUMMARY